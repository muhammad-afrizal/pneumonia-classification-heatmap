<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hasil Prediksi - Deteksi Pneumonia</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body class="bg-result">
    {% include 'navbar.html' %}
    <div class="container py-4">
        <h1 class="mb-3 text-center">Hasil Prediksi</h1>
        <h5>Hasil Prediksi untuk {{ filename }}</h5>

        <div class="row mt-4 align-items-center">
            <div class="col-md-6 text-center">
                <h3>Gambar Asli</h3>
                <img src="{{ url_for('static', filename='uploads/' + filename) }}" class="img-fluid mb-3"
                    style="max-width:400px; height: auto;">
            </div>
            <div class="col-md-6">
                <h4>Prediksi</h4>
                <p><strong>Kategori:</strong> {{ prediction }}</p>
                <p><strong>Confidence:</strong> {{ confidence }}</p>

                {% if prediction == "Normal" %}
                <div class="alert alert-success">
                    <h5>Interpretasi</h5>
                    <p>
                        Gambar X-ray ini terdeteksi memiliki indikasi
                        Normal dengan confidence {{ confidence }}.
                    </p>
                    <p>
                        Silahkan periksa visualisasi heatmap di bawah yang
                        menunjukkan area-area yang dianalisis model dalam menentukan bahwa
                        gambar X-ray ini Normal. Intensitas warna mencerminkan tingkat
                        pentingnya setiap area, semakin terang warnanya, semakin besar
                        pengaruh area tersebut terhadap prediksi model.
                    </p>
                </div>
                {% endif %}

                {% if prediction == "Pneumonia" %}
                <div class="alert alert-danger">
                    <h5>Interpretasi</h5>
                    <p>
                        Gambar X-ray ini terdeteksi memiliki indikasi
                        pneumonia dengan confidence {{ confidence }}.
                    </p>
                    <p>
                        Silahkan periksa visualisasi heatmap di bawah yang
                        menunjukkan area-area dalam gambar X-ray yang paling berpengaruh
                        terhadap keputusan model. Intensitas warna mencerminkan tingkat
                        pentingnya setiap area - semakin terang warnanya, semakin besar
                        pengaruh area tersebut terhadap prediksi model.
                    </p>
                </div>
                {% endif %}

            </div>
        </div>

        <!-- Grid tampilan 3 gambar (tanpa gambar asli yang duplikat) -->
        <div class="row mt-4">
            <div class="col-md-4 text-center mb-4">
                <h4>Gambar CLAHE</h4>
                <img src="{{ url_for('static', filename='uploads/' + clahe_filename) }}" class="img-fluid mb-3 mx-auto"
                    style="max-height:300px; width: 150px; height: 150px; object-fit: cover;">
                <p class="text-muted">Gambar setelah peningkatan kontras CLAHE</p>
            </div>
            <div class="col-md-4 text-center mb-4">
                <h4>Saliency Map (CLAHE)</h4>
                <img src="{{ url_for('static', filename='uploads/' + saliency_filename) }}" class="img-fluid mb-3 mx-auto"
                    style="max-height:300px; width: 150px; height: 150px; object-fit: cover;">
                <p class="text-muted">Area penting yang dianalisis model</p>
            </div>
            <div class="col-md-4 text-center mb-4">
                <h4>Overlay Saliency (CLAHE)</h4>
                <img src="{{ url_for('static', filename='uploads/' + overlay_filename) }}" class="img-fluid mb-3 mx-auto"
                    style="max-height:300px; width: 150px; height: 150px; object-fit: cover;">
                <p class="text-muted">Gabungan gambar CLAHE dan area penting</p>
            </div>
        </div>

        <!-- Feedback Form -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Feedback untuk Sistem</h5>
                    </div>
                    <div class="card-body">
                        <form id="feedbackForm">
                            <input type="hidden" id="history_id" value="{{ history_id }}">
                            
                            <div class="mb-3">
                                <label class="form-label">Apakah hasil prediksi ini benar?</label>
                                <div>
                                    <button type="button" class="btn btn-success me-2" id="feedbackBenar">✅ BENAR</button>
                                    <button type="button" class="btn btn-danger" id="feedbackSalah">❌ SALAH</button>
                                </div>
                                <input type="hidden" id="is_accurate" name="is_accurate">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Seberapa berguna sistem ini? (1-5)</label>
                                <div class="scale-container">
                                    <div class="d-flex justify-content-center gap-2">
                                        <button type="button" class="btn scale-btn btn-outline-primary" data-rating="1">1</button>
                                        <button type="button" class="btn scale-btn btn-outline-primary" data-rating="2">2</button>
                                        <button type="button" class="btn scale-btn btn-outline-primary" data-rating="3">3</button>
                                        <button type="button" class="btn scale-btn btn-outline-primary" data-rating="4">4</button>
                                        <button type="button" class="btn scale-btn btn-outline-primary" data-rating="5">5</button>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between small text-muted mt-1">
                                    <span>Tidak Berguna</span>
                                    <span>Sangat Berguna</span>
                                </div>
                                <input type="hidden" id="usefulness_rating" name="usefulness_rating">
                                <div class="mt-2 text-center">
                                    <span id="ratingDescription" class="badge bg-info">Pilih tingkat kegunaan</span>
                                </div>
                            </div>
                            
                            <div class="mb-3" id="reasonSection" style="display: none;">
                                <label for="reason" class="form-label">Alasan (opsional):</label>
                                <textarea class="form-control" id="reason" name="reason" rows="3" placeholder="Beritahu kami mengapa hasil prediksi benar atau salah..."></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary" id="submitFeedback" disabled>Kirim Feedback</button>
                        </form>
                        
                        <div id="feedbackSuccess" class="alert alert-success mt-3" style="display: none;">
                            Terima kasih atas feedback Anda! Feedback Anda sangat berharga untuk pengembangan sistem.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-3 text-center">
            <a href="/predict" class="btn btn-secondary">Prediksi</a>
            <a href="/" class="btn btn-secondary">Beranda</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Feedback form handling
        document.addEventListener('DOMContentLoaded', function() {
            const feedbackForm = document.getElementById('feedbackForm');
            const submitBtn = document.getElementById('submitFeedback');
            const reasonSection = document.getElementById('reasonSection');
            const feedbackSuccess = document.getElementById('feedbackSuccess');
            
            // Accuracy buttons
            document.getElementById('feedbackBenar').addEventListener('click', function() {
                document.getElementById('is_accurate').value = 'true';
                this.classList.add('active');
                document.getElementById('feedbackSalah').classList.remove('active');
                reasonSection.style.display = 'block';
                submitBtn.disabled = false;
            });
            
            document.getElementById('feedbackSalah').addEventListener('click', function() {
                document.getElementById('is_accurate').value = 'false';
                this.classList.add('active');
                document.getElementById('feedbackBenar').classList.remove('active');
                reasonSection.style.display = 'block';
                submitBtn.disabled = false;
            });
            
            // Rating scale buttons
            const scaleButtons = document.querySelectorAll('.scale-btn');
            const ratingDescription = document.getElementById('ratingDescription');
            
            scaleButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const rating = this.getAttribute('data-rating');
                    document.getElementById('usefulness_rating').value = rating;
                    
                    // Update button appearance
                    scaleButtons.forEach(btn => {
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-outline-primary');
                    });
                    this.classList.remove('btn-outline-primary');
                    this.classList.add('btn-primary');
                    
                    // Update description
                    const descriptions = {
                        '1': 'Sangat Tidak Berguna',
                        '2': 'Tidak Berguna',
                        '3': 'Cukup',
                        '4': 'Berguna',
                        '5': 'Sangat Berguna'
                    };
                    ratingDescription.textContent = descriptions[rating];
                    ratingDescription.className = 'badge bg-' + 
                        (rating <= 2 ? 'danger' : rating == 3 ? 'warning' : 'success');
                });
            });
            
            // Form submission
            feedbackForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData();
                formData.append('history_id', document.getElementById('history_id').value);
                formData.append('is_accurate', document.getElementById('is_accurate').value);
                formData.append('usefulness_rating', document.getElementById('usefulness_rating').value);
                formData.append('reason', document.getElementById('reason').value);
                
                fetch('/feedback', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        feedbackSuccess.style.display = 'block';
                        feedbackForm.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
    </script>
</body>

</html>